<?phpdefined('_FINDEX_') or die('Access Denied');// Proses Simpan Approvelif(isset($_POST['Approve'])){global $tgl_sekarang;	$book 			= $_POST['buku'];	$rekan 			= $_POST['rekanan'];	$prog 			= $_POST['prog'];	$noreg 			= $_POST['NoReg'];	$Nim			= $_POST['NIM'];	$pass			= md5(123456);$c=_num_rows(_query("SELECT * FROM mahasiswa WHERE NIM='$_POST[NIM]'"));if ($c > 0){alert('error','Proses Approval Mahasiswa Baru Gagal. Data NIM Sudah Ada Dalam Database');CatatLog($_SESSION[Nama],'Approval Mahasiswa Baru','Proses Approval Mahasiswa Baru Gagal. Data NIM Sudah Ada Dalam Database');htmlRedirect('go-transaksi.html',2);	}else{//Update Keuangan Mahasiswa$s = _query("UPDATE keuanganmhsw SET KeuanganMhswID='$_POST[NIM]',Aktif='Y', ApproveDate='$tgl_sekarang',keterangan='Approved' WHERE RegID='$noreg'");//Update Mahasiswa$s1 =_query( "UPDATE mahasiswa SET NIM='$Nim',username='$Nim', password='$pass',RekananID='$rekan', aktif='Y' WHERE NoReg='$noreg'");//Update User$s2 =_query("UPDATE useryapan SET username='$Nim', password='$pass', aktif='Y' WHERE SessionID='$noreg'");//tampilkan Pesanalert('info','Approval Mahasiswa Baru Berhasil Di Proses');CatatLog($_SESSION[Nama],'Approval Mahasiswa Baru','Approval Mahasiswa Baru Berhasil Di Proses');htmlRedirect('go-transaksi.html',2);}//END}//Simpan Edit BiayaMahasiswaif(isset($_POST['simpanBiayaMhs'])){	$JuMlah = str_replace(',','',$_POST['nominal']);	$qr		= _query("UPDATE keuanganmhsw SET TotalBiaya='$JuMlah'	  WHERE RegID ='$_POST[RegID]'");  	if($qr AND isset($_POST['simpanBiayaMhs'])){				alert('info','Keuangan Mahasiswa Berhasil di Update');		CatatLog($_SESSION[Nama],'Update Keuangan Mahasiswa','Keuangan Mahasiswa Berhasil di Update');	}}// Hapus TransaKSIif(isset($_POST['deleteTrans'])){$source = @$_POST['checkTrans'];$source = multipleSelect($source);	if(empty($source)){	alert('error','Pilih Data Transaksi yang Akan di hapus');	CatatLog($_SESSION['Nama'],'Hapus Transaksi','Gagal. Transaksi Belum Dipilih');	}else{	$reg = explode(",",$source);	foreach($reg as $id)	{		$w = GetFields('transaksi', 'TransID', $id, '*');		if($w['Transaksi']=='14'){//hapus transaksi Honor Rektorat		$tabela	="transaksihnrektor";		$kondisia="Notrans='$id'";		$deletea = delete($tabela,$kondisia);			}elseif($w['Transaksi']=='15'){//hapus transaksi Gaji Karyawan 		$tabela	="transaksihnrstaff";		$kondisia="Notrans='$id'";		$deletea = delete($tabela,$kondisia);			}elseif($w['Transaksi']=='16'){//hapus transaksi Gaji Dosen 		$tabela	="transaksihnrdosen";		$kondisia="Notrans='$id'";		$deletea = delete($tabela,$kondisia);			}elseif($w['Transaksi']=='19'){//hapus transaksi Approvel		$deletea = _query("UPDATE keuanganmhsw SET Potongan='', TotalBiaya ='', Aktif='Y', ApproveDate='',keterangan='' WHERE RegID='$w[AccID]'");			//Update Mahasiswa		$s1 =_query( "UPDATE mahasiswa SET NIM='',username='', password='', aktif='N' WHERE NoReg='$w[AccID]'");		//Update User		$s2 =_query("UPDATE useryapan SET username='', password='', aktif='N' WHERE SessionID='$w[AccID]'");		}elseif($w['Transaksi']=='28'){//hapus transaksi Pembelian		$d = GetFields('transaksi', 'TransID', $id, '*');		if($d['ProdukId']=='4'){			$p = GetFields('transaksijasalmamater', 'Notrans', $id, '*');				//Update M				$sisaM=GetName('jasalmamater','ukuran','m','total');				$totalM=$sisaM - $p['summ'];				$updateM=_query("UPDATE jasalmamater SET 						total		= '$totalM'						WHERE ukuran = 'm'");				//Update L				$sisaL=GetName('jasalmamater','ukuran','l','total');				$totalL=$sisaL - $p['suml'];				$updateL=_query("UPDATE jasalmamater SET 						total		= '$totalL'						WHERE ukuran = 'l'");				//Update XL				$sisaXL=GetName('jasalmamater','ukuran','xl','total');				$totalXL=$sisaXL - $p['sumxl'];				$updateXL=_query("UPDATE jasalmamater SET 						total		= '$totalXL'						WHERE ukuran = 'xl'");				//Update XXL				$sisaXXL=GetName('jasalmamater','ukuran','xxl','total');				$totalXXL=$sisaXXL - $p['sumxxl'];				$updateXXL=_query("UPDATE jasalmamater SET 						total		= '$totalXXL'						WHERE ukuran = 'xxl'");			//Hapus			$deleteTr = delete("transaksijasalmamater","Notrans='$id'");			} else {			//Hapus			$deleteTr = delete("transaksibeli","Notrans='$id'");			}		}elseif($w['Transaksi']=='29'){//hapus transaksi Penjualan		$d = GetFields('transaksi', 'TransID', $id, '*');				if($d['ProdukId']=='4'){					$p = GetFields('transaksijual', 'Notrans', $id, '*');						//Update Jas Almamater						$sisa =GetName('jasalmamater','ukuran',$p['ukuran'],'total');						$total =$sisa + $p['Jumlah'];						$update =_query("UPDATE jasalmamater SET 								total		= '$total'								WHERE ukuran = '$p[ukuran]'");				}		$deleteTr = delete("transaksijual","Notrans='$id'");		}elseif($w['Transaksi']=='30'){//hapus transaksi Pemakaian		$deleteTr = delete("transaksipakai","Notrans='$id'");		}		$tabel	="transaksi";		$kondisi="TransID='$id'";		$delete = delete($tabel,$kondisi);	 	}		alert('info','Data Transaksi Berhasil Di Hapus');		CatatLog($_SESSION[Nama],'Hapus Data Transaksi','Data Transaksi Berhasil Di Hapus');	}}//import Transaksiif(isset( $_POST['ImportTransa'])){global $tgl_sekarang;$waktu=time(); include "librari/excel_reader.php";$data = new Spreadsheet_Excel_Reader($_FILES['import_file']['tmp_name']);$baris = $data->rowcount($sheet_index=0);$sukses = 0;$gagal = 0;$trans=$_POST['jenistransaksi'];if($trans=='17' OR $trans=='18' ){		for ($i=2; $i<=$baris; $i++)		{ 				$n1 = trimed($data->val($i, 1));//Nim				$n2 = trimed($data->val($i, 2));//Keterangan				$n3 = trimed($data->val($i, 3));//Tanggal				$n4 = trimed($data->val($i, 4));//Jumlah		// cek data keuangan mahasiswa.		$transID=GenerateID('transaksi','TransID',$n4,'BAU');		$cekkeu=_query("SELECT * FROM mahasiswa a, keuanganmhsw b WHERE a.NIM=b.KeuanganMhswID AND a.NIM='$n1'");		$cekkeuangan = _num_rows($cekkeu);	if(!empty($cekkeuangan)) {		$w=_fetch_array($cekkeu);		$book=($w[JenjangID]=='S1')? 4: 7;		$buku=($w[JenjangID]=='S1')? 1: 9;				//masukkan transaksi		$hasil=_query("INSERT INTO transaksi (TransID, Buku, Transaksi, Debet, Kredit, AccID, TglBayar, SubmitBy, TglSubmit, Uraian, TanggalCatat, IDpiutang, SubID) VALUES 		('$transID', '$buku', '$trans', '$n4', '0', '$w[NoReg]', '$n3', '$_SESSION[Nama]', '$n3', '$n2', '$waktu', '$book','')");	//masukkan Piutang		$hasil1=_query("INSERT INTO transaksi (TransID, Buku, Transaksi, Debet, Kredit, AccID, TglBayar, SubmitBy, TglSubmit, Uraian, TanggalCatat, IDpiutang, SubID) VALUES 		('$transID', '$book', '$trans', '0', '$n4', '$w[NoReg]', '$n3', '$_SESSION[Nama]', '$n3', '$n2', '$waktu', '$book','')");				if ($hasil) $sukses++; else $gagal++;	}}}elseif($trans=='14'){//import Honor Rektorat		for ($i=2; $i<=$baris; $i++)		{ 				$n1 = trimed($data->val($i, 1));//UserId				$n2 = trimed($data->val($i, 2));//Tanggal				$n3 = trimed($data->val($i, 3));//Keterangan				$n4 = trimed($data->val($i, 4));//Gaji Pokok				$n5 = trimed($data->val($i, 5));//tunjangan Jabatan				$n6 = trimed($data->val($i, 6));//tunjangan Transport				$n7 = trimed($data->val($i, 7));//total		// cek data keuangan mahasiswa.if(!empty($n1)){	$TrackID=GenerateID('transaksi','TransID',$n2,'BAU');	$cekTransaksi=_query("SELECT * FROM jenistransaksi WHERE id='$trans'");	if (_num_rows($cekTransaksi)>0)		{			$row			=_fetch_array($cekTransaksi);			$NamaTransaksi	=$row['Nama'];			$d				=$row['BukuDebet'];			$k				=$row['BukuKredit'];			$deb			= explode(',',$d);			$kredt			= explode(',',$k);			if (!empty($d))			{				foreach($deb as $vald => $debet)				{				$transd = "INSERT INTO transaksi (TransID, Buku, Transaksi, Debet, Kredit, AccID, TglBayar, SubmitBy, TglSubmit, Uraian, TanggalCatat, IDpiutang) VALUES 				('$TrackID', '$debet', '$trans', '$n7', '0', '$n1', '$n2', '$_SESSION[Nama]', '$tgl_sekarang', '$n3', '$waktu', '')";				$hasil=_query($transd);					}			}			if (!empty($k))			{				foreach($kredt as $vald => $kredit)				{				$transk = "INSERT INTO transaksi (TransID, Buku, Transaksi, Debet, Kredit, AccID, TglBayar, SubmitBy, TglSubmit, Uraian, TanggalCatat, IDpiutang) VALUES 				('$TrackID', '$kredit', '$trans', '0', '$n7', '$n1', '$n2', '$_SESSION[Nama]', '$tgl_sekarang', '$n3', '$waktu', '')";				$hasil=_query($transk);								}			}		$hasil=_query("INSERT INTO transaksihnrektor (Notrans,userid,gajipokok,transport,jabatan,potongan,Total,TglBayar,SubmitBy) VALUES('$TrackID', '$n1', '$n4', '$n6', '$n5', '','$n7', '$n2','$_SESSION[Nama]')");		}	if ($hasil) $sukses++; else $gagal++;	}}}else{		for ($i=2; $i<=$baris; $i++)		{ 			$n1 = trimed($data->val($i, 1));			$n2 = trimed($data->val($i, 2));			$n3 = trimed($data->val($i, 3));		$transID=GenerateID('transaksi','TransID',$n1,'BAU');		$cekTransaksi=_query("SELECT * FROM jenistransaksi WHERE id='$trans'");		$ada=mysql_num_rows($cekTransaksi);		if ($ada > 0 )			{			$row			=_fetch_array($cekTransaksi);			$NamaTransaksi	=$row['Nama'];			$d				=$row['BukuDebet'];			$k				=$row['BukuKredit'];			$deb			= explode(',',$d);			$kredt			= explode(',',$k);			if (!empty($d))			{				foreach($deb as $vald => $debet)				{				$transd = "INSERT INTO transaksi (TransID, Buku, Transaksi, Debet, Kredit, AccID, TglBayar, SubmitBy, TglSubmit, Uraian, TanggalCatat) VALUES 				('$transID', '$debet', '$trans', '$n3', '0', '', '$n1', '$_SESSION[Nama]', '$tgl_sekarang', '$n2', '$waktu')";				$hasil=_query($transd);					}			}			if (!empty($k))			{				foreach($kredt as $vald => $kredit)				{				$transk = "INSERT INTO transaksi (TransID, Buku, Transaksi, Debet, Kredit, AccID, TglBayar, SubmitBy, TglSubmit, Uraian, TanggalCatat) VALUES 				('$transID', '$kredit', '$trans', '0', '$n3', '', '$n1', '$_SESSION[Nama]', '$n1', '$n2', '$waktu')";				$hasil=_query($transk);								}			}		}if ($hasil) $sukses++; else $gagal++;	}}//tampilkan Pesan	alert("info","Import Data Transaksi Selesai Sukses : $sukses | Gagal : $gagal ");	CatatLog($_SESSION[Nama],"Import Data Transaksi","Import Data Transaksi Selesai | Sukses : $sukses | Gagal : $gagal ");}