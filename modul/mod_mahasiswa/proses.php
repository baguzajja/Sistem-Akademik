<?phpdefined('_FINDEX_') or die('Access Denied');global $today,$BulanIni,$TahunIni,$tgl_sekarang;//fuctionfunction NoReg($id){$w = GetFields('tahun', 'Tahun_ID', $id, '*');$tgle=substr("$w[TglBuka]",8,2);$blne=substr("$w[TglBuka]",5,2);$thne=substr("$w[TglBuka]",0,4);$tglNIM=$thne.$blne.$tgle;// cari id registrasi terakhir yang berawalan tanggal hari ini$query = "SELECT max(NoReg) AS last FROM mahasiswa WHERE NoReg LIKE 'REG$tglNIM%'";$hasil = _query($query);$data  = _fetch_array($hasil);$lastNoTransaksi = $data['last'];$lastNoUrut = substr($lastNoTransaksi, 11, 4); $nextNoUrut = $lastNoUrut + 1;$nextNoTransaksi = "REG".$tglNIM.sprintf('%04s', $nextNoUrut);return $nextNoTransaksi;}//Tambah dan Edit Mahasiswaif(isset($_POST['UpdateMahasiswa'])) {  if (empty($_POST[password])){  $Tg=sprintf("%02d%02d%02d",$_POST[thntl],$_POST[blntl],$_POST[tgltl]);  $upMahasiswa= _query("UPDATE mahasiswa SET username='$_POST[username]',	  TempatLahir		='$_POST[TempatLahir]',	  TanggalLahir		='$Tg',	  Kelamin			='$_POST[Kelamin]',	  WargaNegara		='$_POST[WargaNegara]',	  Kebangsaan		='$_POST[Kebangsaan]',	  Agama				='$_POST[Agama]',	  StatusSipil		='$_POST[StatusSipil]',	  AlamatAsal		='$_POST[AlamatAsal]',	  RTAsal			='$_POST[RTAsal]',	  RWAsal			='$_POST[RWAsal]',	  KotaAsal			='$_POST[KotaAsal]',	  KodePosAsal		='$_POST[KodePosAsal]',	  PropinsiAsal		='$_POST[PropinsiAsal]',	  NegaraAsal		='$_POST[NegaraAsal]',	  Handphone			='$_POST[Handphone]',	  Email				='$_POST[Email]',	  Alamat			='$_POST[Alamat]',	  RT				='$_POST[RT]',	  RW				='$_POST[RW]',	  Kota				='$_POST[Kota]',	  KodePos			='$_POST[KodePos]',	  Propinsi			='$_POST[Propinsi]',	  Negara			='$_POST[Negara]',	  Telepon			='$_POST[Telepon]',	  identitas_ID		='$_POST[institusi]',      Nama				='$_POST[Nama]',	  IDProg			='$_POST[kelas]',	  kode_jurusan		='$_POST[prodi]',	  Kurikulum_ID		='$_POST[kons]',	  PenasehatAkademik	='$_POST[pa]',	  StatusAwal_ID		='$_POST[StatusAwal_ID]',	  StatusMhsw_ID		='$_POST[StatusMhsw_ID]',	  NamaAyah			='$_POST[NamaAyah]',	  AgamaAyah			='$_POST[AgamaAyah]',	  PendidikanAyah	='$_POST[PendidikanAyah]',	  PekerjaanAyah		='$_POST[PekerjaanAyah]',	  NamaIbu			='$_POST[NamaIbu]',	  AgamaIbu			='$_POST[AgamaIbu]',	  PendidikanIbu		='$_POST[PendidikanIbu]',	  PekerjaanIbu		='$_POST[PekerjaanIbu]',	  AlamatOrtu		='$_POST[AlamatOrtu]',	  KotaOrtu			='$_POST[KotaOrtu]',	  KodePosOrtu		='$_POST[KodePosOrtu]',	  PropinsiOrtu		='$_POST[PropinsiOrtu]',	  NegaraOrtu		='$_POST[NegaraOrtu]',	  TeleponOrtu		='$_POST[TeleponOrtu]',	  HandphoneOrtu		='$_POST[HandphoneOrtu]',	  EmailOrtu			='$_POST[EmailOrtu]',	  AsalSekolah		='$_POST[AsalSekolah]',	  JenisSekolah_ID	='$_POST[JenisSekolah_ID]',	  JurusanSekolah	='$_POST[JurusanSekolah]',	  TahunLulus		='$_POST[TahunLulus]',	  NilaiSekolah		='$_POST[NilaiSekolah]',  	  aktif				='$_POST[Aktif]'	  WHERE MhswID			='$_POST[id]'");  	$upUseryapan=_query("UPDATE useryapan SET		email       	= '$_POST[Email]',		aktif       	= '$_POST[Aktif]'		WHERE username	= '$_POST[username]'");		$upKeuangan=_query("UPDATE keuanganmhsw SET		kelasID       	= '$_POST[kelas]'		WHERE KeuanganMhswID = '$_POST[username]'");	  } else {  $pasws=md5($_POST[password]);  $Tg=sprintf("%02d%02d%02d",$_POST[thntl],$_POST[blntl],$_POST[tgltl]);   $tglls=sprintf("%02d%02d%02d",$_POST[thntlls],$_POST[blntlls],$_POST[tgltlls]);   _query("UPDATE mahasiswa SET username='$_POST[username]',password='$pasws',  TempatLahir='$_POST[TempatLahir]',  TanggalLahir='$Tg',  Kelamin='$_POST[Kelamin]',  WargaNegara='$_POST[WargaNegara]',  Kebangsaan='$_POST[Kebangsaan]',  Agama='$_POST[Agama]',  StatusSipil='$_POST[StatusSipil]',  AlamatAsal='$_POST[AlamatAsal]',  RTAsal='$_POST[RTAsal]',  RWAsal='$_POST[RWAsal]',  KotaAsal='$_POST[KotaAsal]',  KodePosAsal='$_POST[KodePosAsal]',  PropinsiAsal='$_POST[PropinsiAsal]',  NegaraAsal='$_POST[NegaraAsal]',  Handphone='$_POST[Handphone]',  Email='$_POST[Email]',  Alamat='$_POST[Alamat]',  RT='$_POST[RT]',  RW='$_POST[RW]',  Kota='$_POST[Kota]',  KodePos='$_POST[KodePos]',  Propinsi='$_POST[Propinsi]',  Negara='$_POST[Negara]',  Telepon='$_POST[Telepon]',  identitas_ID='$_POST[institusi]',  Nama='$_POST[Nama]',  IDProg='$_POST[kelas]',  kode_jurusan='$_POST[prodi]',  Kurikulum_ID='$_POST[kons]',  PenasehatAkademik='$_POST[pa]',  StatusAwal_ID='$_POST[StatusAwal_ID]',  StatusMhsw_ID='$_POST[StatusMhsw_ID]',  NamaAyah='$_POST[NamaAyah]',  AgamaAyah='$_POST[AgamaAyah]',  PendidikanAyah='$_POST[PendidikanAyah]',  PekerjaanAyah='$_POST[PekerjaanAyah]',  NamaIbu='$_POST[NamaIbu]',  AgamaIbu='$_POST[AgamaIbu]',  PendidikanIbu='$_POST[PendidikanIbu]',  PekerjaanIbu='$_POST[PekerjaanIbu]',  AlamatOrtu='$_POST[AlamatOrtu]',  KotaOrtu='$_POST[KotaOrtu]',  KodePosOrtu='$_POST[KodePosOrtu]',  PropinsiOrtu='$_POST[PropinsiOrtu]',  NegaraOrtu='$_POST[NegaraOrtu]',  TeleponOrtu='$_POST[TeleponOrtu]',  HandphoneOrtu='$_POST[HandphoneOrtu]',  EmailOrtu='$_POST[EmailOrtu]',  AsalSekolah='$_POST[AsalSekolah]',  JenisSekolah_ID='$_POST[JenisSekolah_ID]',  JurusanSekolah='$_POST[JurusanSekolah]',  TahunLulus='$_POST[TahunLulus]',  NilaiSekolah='$_POST[NilaiSekolah]',    aktif='$_POST[Aktif]'  WHERE MhswID ='$_POST[id]'");    	$upUseryapan=_query("UPDATE useryapan SET		password    	= '$pasws',		email       	= '$_POST[Email]',		aktif       	= '$_POST[Aktif]'		WHERE username	= '$_POST[username]'");	 $upKeuangan=_query("UPDATE keuanganmhsw SET		kelasID       	= '$_POST[kelas]'		WHERE KeuanganMhswID = '$_POST[username]'");  }	alert('info','Mahasiswa Berhasil di Update');	CatatLog($_SESSION[Nama],'Update Data Mahasiswa','Mahasiswa Berhasil di Update');}//Tambah dan Edit Mahasiswaif(isset($_POST['simpanMaba'])) {	$Tg=sprintf("%02d%02d%02d",$_POST['thntl'],$_POST['blntl'],$_POST['tgltl']);  		$pass=md5(123456);	$jenjang = GetaField('jurusan', 'kode_jurusan', $_POST['prodi'], 'jenjang');	$cek=_query("SELECT * FROM mahasiswa WHERE NoReg='$_POST[NoReg]'");		if (_num_rows($cek)>0)		{		alert('error',"Pendaftaran Mahasiswa Baru Gagal Di proses.ID Registrasi : <b>$_POST[NoReg]</b> Sudah ada. Silahkan Ulangi Lagi");		CatatLog($_SESSION['Nama'],'Pendaftaran Mahasiswa Baru','Pendaftaran Mahasiswa Baru Gagal.No Registrasi Sudah ada');		}else{		$insert=_query("INSERT INTO mahasiswa (NoReg,username,password,Angkatan,Kurikulum_ID,identitas_ID,RekananID,Nama,StatusAwal_ID,StatusMhsw_ID,IDProg,kode_jurusan,PenasehatAkademik,Kelamin,WargaNegara,Kebangsaan,TempatLahir,TanggalLahir,Agama,StatusSipil,Telepon,Handphone,AlamatAsal,KotaAsal,RTAsal,RWAsal,KodePosAsal,PropinsiAsal,NegaraAsal)VALUES		('$_POST[NoReg]','','$pass','$_POST[Angkatan]','$_POST[konsentrasi]','$_POST[institusi]','$_POST[rekanan]','$_POST[Nama]','$_POST[StatusAwal_ID]','$_POST[StatusMhsw_ID]','$_POST[kelas]','$_POST[prodi]','$_POST[pa]','$_POST[Kelamin]','$_POST[WargaNegara]','$_POST[Kebangsaan]','$_POST[TempatLahir]','$Tg','$_POST[Agama]','$_POST[StatusSipil]','$_POST[Telepon]','$_POST[Handphone]','$_POST[Alamat]','$_POST[Kota]','$_POST[RT]','$_POST[RW]','$_POST[KodePos]','$_POST[Propinsi]','$_POST[Negara]')");		$idMhs=mysql_insert_id();	if($insert){		//INSERT USER		$InsertUserYapan=_query("INSERT INTO useryapan(username,password,LevelID,Nama,IdentitasID,kodeProdi,Bagian,Jabatan,email,aktif,Log,SessionID)VALUES		('','$pass','4','$_POST[Nama]','$_POST[institusi]','$_POST[prodi]','mahasiswa','19','','N','','$_POST[NoReg]')");		//INSERT keuangan mahasiswa		$keuanganmhsw = _query("INSERT INTO keuanganmhsw (KeuanganMhswID,RegID,IdentitasID,ProdiID,TahunID,JenjangID,Potongan,TotalBiaya,Aktif,SubmitOleh,TglSubmit,Keterangan,lunas)			values('$_POST[NoReg]','$_POST[NoReg]','$_POST[institusi]','$_POST[prodi]','$_POST[Angkatan]','$jenjang','','','N','$_SESSION[Nama]','$tgl_sekarang','','N')");  	}		alerPrint('Pendaftaran Mahasiswa',"Mahasiswa Baru Berhasil Di Simpan. ID REGISTRASI : <b>$_POST[NoReg]</b>","go-mahasiswa.html","get-print-maba-$idMhs.html");	CatatLog($_SESSION[Nama],'Pendaftaran Mahasiswa Baru',"Mahasiswa Baru Berhasil Di Simpan ID REGISTRASI : <b>$_POST[NoReg]</b>");		}}// Hapus Mahasiswaif(isset($_POST['delete'])){	$source = @$_POST['check'];	$source = multipleSelect($source);	if(empty($source)){	alert('error','Pilih Mahasiswa yang Akan di Hapus');	CatatLog($_SESSION[Nama],'Hapus Mahasiswa','Gagal Meng-Hapus Mahasiswa Belum Dipilih');	}else{	$del = explode(",",$source);	foreach($del as $id)	{		$cek		=_fetch_array(_query("SELECT * FROM mahasiswa WHERE MhswID='$id'"));		$whereUser	=($cek['NIM']=='') ? "WHERE SessionID='$cek[NoReg]'":"WHERE username='$cek[NIM]'";		 if ($cek['Foto']!=''){			$delUser=_query("DELETE FROM useryapan $whereUser");			$delBau=_query("DELETE FROM keuanganmhsw WHERE RegID='$cek[NoReg]'");			$delTransaksi=_query("DELETE FROM transaksi WHERE AccID='$cek[NoReg]'");			$delMhsw=_query("DELETE FROM mahasiswa WHERE MhswID='$id'");			$hapusft=unlink("$cek[Foto]");			$hapus=($delUser AND  $delBau AND  $delTransaksi AND $delMhsw AND $hapusft)? true : false;		  }else{			 $delUser=_query("DELETE FROM useryapan $whereUser");			 $delBau=_query("DELETE FROM keuanganmhsw WHERE RegID='$cek[NoReg]'");			 $delTransaksi=_query("DELETE FROM transaksi WHERE AccID='$cek[NoReg]'");			 $delMhsw=_query("DELETE FROM mahasiswa WHERE MhswID='$id'");			$hapus=($delUser AND  $delBau AND  $delTransaksi AND $delMhsw)? true : false;		  }	}	if($hapus){		alert('info','Mahasiswa Berhasil di Hapus');		CatatLog($_SESSION[Nama],'Hapus Data Mahasiswa','Mahasiswa Berhasil di Hapus');		}	}}// Import Data Mahasiswaif(isset($_POST['ImportMahasiswa'])){global $tgl_sekarang;$identitas=$_SESSION['Identitas'];include "librari/excel_reader.php";	$data = new Spreadsheet_Excel_Reader($_FILES['import_file']['tmp_name']);	$baris = $data->rowcount($sheet_index=0);	$sukses = 0;	$gagal = 0;	for ($i=2; $i<=$baris; $i++)	{ 				$n1 = trimed($data->val($i, 1));				$n2 = trimed($data->val($i, 2));				$n3 = trimed($data->val($i, 3));				$n4 = trimed($data->val($i, 4));				$n5 = trimed($data->val($i, 5));				$n6 = trimed($data->val($i, 6));				$n7 = trimed($data->val($i, 7));				$n8 = trimed($data->val($i, 8));				$n9 = trimed($data->val($i, 9));				$n10 = trimed($data->val($i, 10));				$n11 = trimed($data->val($i, 11));				$n12 = trimed($data->val($i, 12));				$n13 = trimed($data->val($i, 13));				$n14 = trimed($data->val($i, 14));				$n15 = trimed($data->val($i, 15));				$n16 = trimed($data->val($i, 16));				$n17 = trimed($data->val($i, 17));				$n18 = trimed($data->val($i, 18));				$n19 = trimed($data->val($i, 19));				$n20 = trimed($data->val($i, 20));				$n21 = trimed($data->val($i, 21));				$n22 = trimed($data->val($i, 22));				$n23 = trimed($data->val($i, 23));				$n24 = trimed($data->val($i, 24));				$n25 = trimed($data->val($i, 25));				$n26 = trimed($data->val($i, 26));				$n27 = trimed($data->val($i, 27));				$n28 = trimed($data->val($i, 28));				$n29 = trimed($data->val($i, 29));				$n30 = trimed($data->val($i, 30));				$aktif	= (empty($n1))? 'N' : 'Y';				$jenjang = GetaField('jurusan', 'kode_jurusan', $n8, 'jenjang');				  // cek data, lalu sisipkan ke dalam tabel				$cek=_query("SELECT * FROM mahasiswa WHERE NIM='$n1'");				$cekdata = _num_rows($cek);				if($cekdata > 0) {				while ($n=_fetch_array($cek)){					$sqldel= _query("DELETE FROM mahasiswa WHERE NIM='$n[NIM]'");					}				}				$cekTahun=_query("SELECT * FROM tahun WHERE Tahun_ID='$n3'");				$hasilCekTahun = _num_rows($cekTahun);				if(empty($hasilCekTahun)) {				alert("error","Oopss...Data TAHUN <b>$n3</b> Tidak Tersedia");				CatatLog($_SESSION[Nama],'Import Data Mahasiswa','Import Gagal Data Tahun Tidak tersedia');				$sukses=false;				}else{				$noReg=NoReg($n3);				$query = "INSERT INTO mahasiswa (NIM,username,NoReg,level_ID,Identitas_ID 	,Angkatan,Kurikulum_ID,RekananID,Nama,IDProg,kode_jurusan,PenasehatAkademik,Kelamin,WargaNegara,TempatLahir,TanggalLahir,Agama,Alamat,Kota,RT,RW,KodePos,Propinsi,Negara,Telepon,Handphone,Email,aktif,LulusUjian,NilaiUjian,GradeNilai,TanggalLulus,IPK,TotalSKS) VALUES ('$n1', '$n1', '$noReg','4','$n2','$n3','$n4','$n5','$n6','$n7','$n8','$n9','$n10','$n11','$n12','$n13','$n14','$n15','$n16','$n17','$n18','$n19','$n20','$n21','$n22','$n23','$n24','$aktif','$n25','$n26','$n27','$n28','$n29','$n30')";				$hasil =_query($query);				//insert User				if ($hasil){				$pass=md5(123456);				$UserYapan ="INSERT INTO useryapan(username,password,LevelID,Nama,IdentitasID,kodeProdi,Bagian,Jabatan,email,aktif,SessionID)VALUES					('$n1','$pass','4','$n6','$n2','$n8','mahasiswa','19','$n24','$aktif','$n2')";				$InsertUserYapan=_query($UserYapan);				if($n25=='N'){				$cekkeu=_query("SELECT * FROM keuanganmhsw WHERE KeuanganMhswID='$n1'");				$cekdatakeu = _num_rows($cekkeu);				if($cekdatakeu > 0) {				while ($n=_fetch_array($cekkeu)){					$sqldelkeuangan= _query("DELETE FROM keuanganmhsw WHERE KeuanganMhswID='$n[KeuanganMhswID]'");					}				}				$s ="INSERT INTO keuanganmhsw (KeuanganMhswID,RegID,IdentitasID,ProdiID,TahunID,JenjangID,Aktif,SubmitOleh,TglSubmit,Keterangan,lunas)					values('$n1','$noReg','$n2','$n8','$n3','$jenjang','$aktif','$_SESSION[Nama]','$tgl_sekarang','Diimport Oleh BAAK','$n25')";				$go = _query($s);				}				}			if ($hasil) $sukses++; else $gagal++;			$sukses=true;			}		}	if($sukses){	alert("info","Import Data Mahasiswa Selesai Sukses : $sukses | Gagal : $gagal ");	CatatLog($_SESSION[Nama],"Import Data Mahasiswa","Import Data Mahasiswa Selesai | Sukses : $sukses | Gagal : $gagal ");	}}// Upload Foto Mahasiswaif(isset($_POST['Upload'])) { 		if(empty($_POST['Id'])){		alert('error','User Belum Ada...!! Buat User Terlebih Dahulu');		CatatLog($_SESSION[Nama],'Upload Foto','Gagal Meng-Upload Foto Karena User Belum Ada.');	}else{		$id 			= $_POST['Id'];		$lokasi_file    = $_FILES['foto']['tmp_name'];		$tipe_file      = $_FILES['foto']['type'];		$nama_file      = $_FILES['foto']['name'];		$acak           = rand(1,99);		$nama_file_unik = $acak.$nama_file;		$dest = "media/images/foto_mahasiswa/";		if (!empty($lokasi_file)){			if ($tipe_file != "image/jpeg" AND $tipe_file != "image/pjpeg"){			alert('info','Upload Gagal, Pastikan File yang di Upload bertipe *.JPG');		}else{			$Upload=UploadPhoto($nama_file_unik,$lokasi_file, $dest);			  if ($Upload){				$fotoc= _query("SELECT * FROM mahasiswa where MhswID='$id' LIMIT 0,1") or die ();				$rfoto=_fetch_array($fotoc);				if($rfoto[Foto]!=''){					unlink("$dest/$rfoto[Foto]");      					unlink("$dest/small_$rfoto[Foto]");      					unlink("$dest/medium_$rfoto[Foto]");      				}				$UpdateFoto = _query("UPDATE mahasiswa set Foto='$nama_file_unik' where MhswID='$id'");				alert('info','Upload Foto Berhasil');				CatatLog($_SESSION[Nama],'Upload Foto','Upload Foto Berhasil');			  } else { 				alert("error", "Gagal Upload Foto.. !! Tidak dapat meng-upload file foto.<br />				Periksa file yg di-upload,  karena besar file dibatasi cuma: <b>$_POST[MAX_FILE_SIZE]</b> byte.");				CatatLog($_SESSION[Nama],'Upload Foto','Gagal Meng-Upload Foto Karena File Terlalu besar');				}			}		}	}}